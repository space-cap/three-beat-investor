"삼박자 투자법" 종목 발굴기 - 구현 계획서1. 프로젝트 목표이정윤 세무사의 '삼박자 투자법(가치, 가격, 정보)' 중 '가치'와 '가격' 측면을 한국투자증권(KIS) API를 통해 자동화한다. 사용자가 HTS/MTS에서 미리 정의한 '조건 검색식'을 API로 호출하여 1차 필터링된 종목 리스트를 확보하는 것을 목표로 한다.2. 아키텍처 개요언어: Python 3.x핵심 라이브러리: requests (API 직접 호출), python-dotenv (설정 관리), pytest (단위 테스트)핵심 구조: KisClient 클래스 기반의 객체 지향 설계폴더 구조:three_beat_investor/
├── .env.example       # 설정 파일 예시
├── .gitignore
├── requirements.txt   # 의존성 관리
├── src/
│   ├── __init__.py
│   ├── kis_client.py  # KIS API 핵심 클라이언트
│   └── main.py        # 프로그램 실행 스크립트
└── tests/
    ├── __init__.py
    └── test_kis_client.py # KisClient 테스트 코드
3. 핵심 컴포넌트: KisClient 클래스 (src/kis_client.py)requests 라이브러리를 사용하여 KIS API와 직접 통신하는 모든 로직을 캡슐화합니다.3.1. 주요 속성app_key: KIS API 앱 키app_secret: KIS API 앱 시크릿account_number: 계좌번호 (API 헤더에 필요)hts_user_id: HTS ID (조건 검색 API 파라미터에 필요)is_prod: 실서버(True) / 모의투자(False) 환경 플래그base_url: 환경에 따른 KIS API 기본 URLaccess_token: 발급받은 액세스 토큰token_expiry: 토큰 만료 시간 (UTC)3.2. 핵심 메서드__init__(self, app_key, app_secret, account_number, hts_user_id, is_prod=False)객체 초기화 및 KIS API URL 설정.is_prod 플래그에 따라 실서버(openapi.koreainvestment.com:9443) 또는 모의투자(openapivts.koreainvestment.com:29443) URL을 base_url에 할당합니다._get_token(self) (Private)(중요) KIS 인증 서버(oauth2/tokenP)에 POST 요청을 보내 액세스 토큰을 발급받습니다.토큰 발급 시 expires_in 값을 기준으로 token_expiry (토큰 만료 시각)를 계산하여 저장합니다.requests.post를 사용합니다._check_token(self) (Private)self.access_token이 없거나 self.token_expiry가 현재 시각(UTC)보다 과거일 경우, _get_token()을 호출하여 토큰을 갱신합니다._get_headers(self, tr_id) (Private)API 호출에 필요한 표준 HTTP 헤더를 생성합니다.Authorization: f"Bearer {self.access_token}"appkey, appsecret, tr_id, custtype: 'P', content-type: 'application/json; charset=utf-8'(중요) account_number는 tr_id에 따라 필요 여부가 다릅니다. 본 프로젝트의 조건 검색 API(FHPST01710000)는 계좌번호 헤더(CANO)를 요구하지 않지만, 확장성을 위해 헤더 생성 로직에 포함시킬 수 있습니다. (본 구현에서는 FHPST01710000에 맞춰 제외)fetch_conditional_search(self, condition_key) (Public)(핵심 기능) '종목조건검색' API(FHPST01710000)를 호출합니다.API 식별:tr_id: FHPST01710000 (실서버), VHPST01710000 (모의투자)URL: /uapi/domestic-stock/v1/quotations/conditional-search(기술적 주석) 'HTS 조건검색'(ctsc001)은 WebSocket API이므로 requests 라이브러리로 구현이 불가합니다. 따라서 HTTP GET 요청으로 동일한 HTS/MTS 저장 조건식을 불러올 수 있는 '종목조건검색'(FHPST01710000) API를 사용합니다.실행 순서:_check_token() 호출하여 토큰 유효성 검사 및 갱신.tr_id 설정 (실서버/모의투자 구분)._get_headers(tr_id) 호출하여 헤더 구성.requests.get의 params (쿼리 스트링) 구성:CUST_ID: self.hts_user_idCOND_KEY: condition_key (사용자가 HTS/MTS에서 저장한 조건식 고유 ID)SEQ: "0" (조회 순서)API 호출 및 response.json() 파싱.output 리스트(종목 코드 리스트) 반환.3.3. 오류 처리모든 requests 호출은 try...except 블록으로 감싸 네트워크 오류, 타임아웃 등을 처리합니다.API 응답의 rt_cd (응답 코드)가 '0'이 아닌 경우, msg1의 오류 메시지를 포함하여 예외(Exception)를 발생시킵니다.4. 실행 흐름 (src/main.py)dotenv.load_dotenv()를 호출하여 .env 파일의 환경 변수를 로드합니다.os.environ.get()을 사용하여 APP_KEY, APP_SECRET, ACCOUNT_NUMBER, HTS_USER_ID, CONDITION_KEY를 가져옵니다. (설정값 누락 시 오류 발생)KisClient 객체를 초기화합니다.client.fetch_conditional_search(CONDITION_KEY)를 호출하여 종목 리스트를 가져옵니다."삼박자 투자법"의 1차 필터(가치, 가격)가 완료되었음을 알리고, 필터링된 종목 코드를 출력합니다.5. 테스트 전략 (tests/test_kis_client.py)pytest와 unittest.mock.patch를 사용합니다.테스트 케이스:test_client_initialization: 클라이언트가 올바른 URL(실서버/모의)로 초기화되는지 테스트.test_get_token_mocked: requests.post를 모킹(mocking)하여, 토큰 발급 로직이 access_token과 token_expiry를 올바르게 설정하는지 테스트.test_fetch_conditional_search_mocked: _check_token과 requests.get을 모킹하여, API가 성공적으로 호출되고 output 리스트를 정확히 파싱하여 반환하는지 테스트.test_token_refresh_logic: token_expiry를 과거로 설정한 후 API를 호출했을 때, _get_token이 (재)호출되는지 테스트.